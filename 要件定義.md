# Chrome拡張機能 要件定義書

## 仮タイトル
**ChatVault Clip — AIチャットを Obsidian に一発保存**  
（候補: 「Chat2Vault」「SlateSync」「LLMクリッパー」など。正式名称は後日確定）

---
## 1 目的とスコープ
| 項目 | 内容 |
|------|------|
| **目的** | Web 版 LLM チャット UI（初期対応: ChatGPT / Claude）の会話を、ワンクリックでユーザー指定の Obsidian Vault に Markdown ノートとして保存する。 |
| **主なユーザー** | • 研究・学習で LLM を利用するナレッジワーカー<br>• プロンプト & 出力を記録したいコンテンツ制作者 / 開発者<br>• Obsidian で PKM を行うすべての人 |
| **ステークホルダー** | • エンドユーザー<br>• プロジェクトオーナー（BOSS）<br>• 元 Obsidian Web Clipper の作者（ライセンス表示が必要） |
| **除外範囲** | • モバイルブラウザ（第2フェーズ以降）<br>• API 経由でのチャット取得（DOM スクレイピングのみ） |

---
## 2 機能要件
### 2.1 対応サービス
- ChatGPT Web (`https://chat.openai.com/*`)
- Claude Web (`https://claude.ai/*`)
- *拡張予定*: Gemini, Perplexity, Poe など（プラガブルなセレクタ構造にする）

### 2.2 取得モード
| モード | トリガー | データソース | 備考 |
|--------|---------|-------------|------|
| **単一メッセージ** | アクションバーに挿入した **Save to Obsidian** ボタン | `.group` 要素（ChatGPT） / `message-row`（Claude） | デフォルト |
| **選択範囲** | ポップアップ → *選択テキストを保存* | `window.getSelection()` | ユーザーがテキストをドラッグ選択した場合 |
| **会話の最新 N 件** | ポップアップ → *直近 N 件を保存* | DOM を下からスライス | N=30 がデフォルト。設定可能 |
| **スレッド全体** | ポップアップ → *全スレッド保存* | すべてのメッセージブロック | 10,000 文字超過で警告表示 |

### 2.3 Markdown 生成
- **Turndown** を利用し、コードブロックはフェンスド形式。
- スピーカー見出し `### User` / `### AI`（ローカライズ可能）。
- KaTeX を検出し、$$ 式 $$ に変換。
- テンプレ変数: `{title} {url} {date} {chatlog}`。

### 2.4 Obsidian 連携
| 項目 | 動作 |
|------|------|
| **保存方法** | **デフォルト: File System Access API**（ユーザーが許可したVaultフォルダに直接書き込み）。<br>失敗・未設定時は `obsidian://new` → Downloads API → クリップボード の順にフォールバック。 |
| **Vault 指定** | `chrome.storage.sync` に文字列入力。URI 規則でバリデーション。 |
| **ファイルパス** | 既定: `LLM Chats/{service}/{YYYY-MM-DD}_{title}.md`。プレースホルダ編集可能。

### 2.5 ユーザーインターフェース
1. **コンテントスクリプト ボタン**  
   - SVG 16×16、テーマカラーを継承。  
   - ツールチップ: "Save to Obsidian"。
2. **ポップアップ (React)**  
   - 生成される Markdown のプレビュー（折りたたみ式）。  
   - オプション：モード選択、最新 N、URL 付与トグル、保存後ノートを開くか。
3. **オプションページ**  
   - Vault 名、デフォルトフォルダ、テンプレート、Markdown 設定。  
   - サービス別セレクタ一覧を追加/削除可能。

---
## 3 非機能要件
| 分類 | 要件 |
|------|------|
| **性能** | ボタン注入はメッセージノード 1 件あたり < 5 ms。メモリ消費 ≤ 20 MB。 |
| **互換性** | Chrome 121+ / Arc 1.35+（いずれも Chromium, Manifest V3）。 |
| **セキュリティ** | Obsidian URI 以外の外部通信なし。`clipboard-write` 権限は必要時のみ。 |
| **国際化** | UI 文字列は英語と日本語（JSON ロケール）。 |
| **アクセシビリティ** | ボタンはフォーカス可能、ARIA ラベル付与、ショートカット (Alt+O)。 |
| **ライセンス** | MIT。元著作権・ライセンス全文を保持。 |

---
## 4 品質保証
- **ユニットテスト**: DOM 抽出関数（Jest + jsdom）
- **E2E**: Puppeteer で拡張読み込み→チャット→Obsidian URI を検証
- **CI**: GitHub Actions（lint, test, build）
- **手動QA**: UI, URI 長さ, ダーク／ライトテーマ動作確認

---
## 5 ロードマップ & マイルストーン
| フェーズ | 成果物 | 目標時期 |
|----------|--------|---------|
| 0 | PoC — ChatGPT 単一メッセージ保存 | **1 週目** |
| 1 | ポップアップ UI & オプション保存 | 2 週目 |
| 2 | Claude 対応 + 最新 N / 選択範囲 | 3 週目 |
| 3 | i18n, アクセシビリティ, クリップボードフォールバック | 4 週目 |
| 4 | Chrome Web Store 提出資料 | 5 週目 |
| 5 | 拡張：Gemini / Perplexity アダプター | 6 週目以降 |

---
## 6 リスクと対策
| リスク | 影響 | 発生確率 | 対策 |
|--------|------|----------|------|
| LLM UI の DOM 変更 | ボタン注入失敗・キャプチャ不能 | 中 | 複数セレクタ実装、設定 JSON で上書き可能に |
| URI 長さ制限越え | ノート未作成 | 高 (長文会話) | クリップボードフォールバック、複数ファイルへ分割 |
| Chrome CSP 変更 | 拡張ブロック | 低 | アセットをバンドル、リリースノート監視 |

---
## 7 未決事項
- 製品名の最終決定
- GitHub Gist や HTML エクスポートなど他の保存先を追加するか？

---
## 8 開発アプローチ（既存プロジェクト活用）
| ステップ | 概要 | 主要ファイル操作 |
|----------|------|------------------|
| **① 初期セットアップ** | 提供 ZIP を展開し、Git リポジトリにコミット。`main` ブランチ = オリジナルソース、`chatvault` ブランチ = 改変作業用。 | `manifest.json`, `README.md`, `package.json` などをそのまま保持 |
| **② 基盤ライブラリの維持** | 元の Web Clipper が依存する React・Tailwind・Vite 設定を流用しつつ、Turndown など追加依存をインストール。 | `vite.config.ts`, `src/styles/*` |
| **③ 新機能のファイル追加** | `src/services/` にチャットごとの DOM 抽出モジュール、`src/contentScripts/` にボタン注入スクリプトを新設。 | `src/services/chatgpt.ts`, `src/contentScripts/chatInject.ts` ほか |
| **④ 既存ファイルの最小改変** | 変更は `manifest.json` の権限追加・UI 文言差し替え・ポップアップ/オプションの拡張に留め、元実装を極力破壊しない。 | `manifest.json`, `src/popup/App.tsx`, `src/options/OptionsApp.tsx` |
| **⑤ コミット履歴の透明性** | オリジナル作者の履歴を保持し、README 冒頭に「派生プロジェクト」である旨と MIT 表記を明示。 | `README.md`, `LICENSE` |
| **⑥ テスト & CI の上乗せ** | 元プロジェクトに Jest/Puppeteer & GitHub Actions を追加し、自動ビルド／リリースフローを強化。 | `.github/workflows/ci.yml` |

この方針により、**オリジナル Web Clipper の恩恵（安定したビルド設定・UI 雛形）を最大限活かしつつ、新機能をモジュール追加で拡張**する形を徹底する。

_End of Document_

